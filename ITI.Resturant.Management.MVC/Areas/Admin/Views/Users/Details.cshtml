@model ITI.Resturant.Management.Application.DTOs.Admin.UserDetailsDto
@{
    ViewData["Title"] = "User Details";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var availableRoles = ViewData["AvailableRoles"] as List<string> ?? new List<string>();
}

<div class="card mb-4">
    <div class="card-header">
        <h4 class="mb-0">User Details</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <dl class="row">
                    <dt class="col-sm-4">Username</dt>
                    <dd class="col-sm-8">@Model.UserName</dd>

                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8">
                        @Model.Email
                        @if (!Model.EmailConfirmed)
                        {
                            <span class="badge bg-warning">Not Confirmed</span>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="confirmEmail('@Model.Id')">
                                Confirm Email
                            </button>
                        }
                        else
                        {
                            <span class="badge bg-success">Confirmed</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Name</dt>
                    <dd class="col-sm-8">@Model.FirstName @Model.LastName</dd>

                    <dt class="col-sm-4">Account Status</dt>
                    <dd class="col-sm-8">
                        @if (Model.IsLockedOut)
                        {
                            <span class="badge bg-danger">Locked</span>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="unlockUser('@Model.Id')">
                                Unlock Account
                            </button>
                        }
                        else
                        {
                            <span class="badge bg-success">Active</span>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="lockUser('@Model.Id')">
                                Lock Account
                            </button>
                        }
                    </dd>
                </dl>

                <div class="mt-3">
                    <button class="btn btn-warning" onclick="resetPassword('@Model.Id')">
                        Reset Password
                    </button>
                </div>
            </div>

            <div class="col-md-6">
                <h5>Roles</h5>
                <div class="mb-3" id="roles-container">
                    @foreach (var role in Model.Roles)
                    {
                        <span class="badge bg-primary me-2">@role</span>
                    }
                </div>
                <div class="input-group">
                    <select class="form-select" id="roleSelect">
                        <option value="">-- Select Role --</option>
                        @foreach (var role in availableRoles.Where(r => !Model.Roles.Contains(r)))
                        {
                            <option value="@role">@role</option>
                        }
                    </select>
                    <button class="btn btn-outline-primary" onclick="addRole('@Model.Id')">Add Role</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Back to List</a>
</div>

@section Scripts {
    <script>
        async function lockUser(userId) {
            if (!confirm('Are you sure you want to lock this user account?')) return;

            try {
                const response = await fetch('/Admin/Users/LockUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: 'id=' + encodeURIComponent(userId)
                });

                if (!response.ok) throw new Error('Failed to lock user');
                location.reload();
            } catch (error) {
                console.error(error);
                alert('Failed to lock user account');
            }
        }

        async function unlockUser(userId) {
            if (!confirm('Are you sure you want to unlock this user account?')) return;

            try {
                const response = await fetch('/Admin/Users/UnlockUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: 'id=' + encodeURIComponent(userId)
                });

                if (!response.ok) throw new Error('Failed to unlock user');
                location.reload();
            } catch (error) {
                console.error(error);
                alert('Failed to unlock user account');
            }
        }

        async function confirmEmail(userId) {
            if (!confirm('Confirm this user\'s email address?')) return;

            try {
                const response = await fetch('/Admin/Users/ConfirmEmail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: 'id=' + encodeURIComponent(userId)
                });

                if (!response.ok) throw new Error('Failed to confirm email');
                location.reload();
            } catch (error) {
                console.error(error);
                alert('Failed to confirm email');
            }
        }

        async function resetPassword(userId) {
            if (!confirm('Are you sure you want to reset this user\'s password?')) return;

            try {
                const response = await fetch('/Admin/Users/ResetPassword', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: 'id=' + encodeURIComponent(userId)
                });

                if (!response.ok) throw new Error('Failed to reset password');
                
                const result = await response.json();
                if (result.success) {
                    alert('Password has been reset to: ' + result.tempPassword);
                }
            } catch (error) {
                console.error(error);
                alert('Failed to reset password');
            }
        }

        async function addRole(userId) {
            const select = document.getElementById('roleSelect');
            const role = select.value;
            if (!role) return;

            try {
                const currentRoles = Array.from(document.querySelectorAll('#roles-container .badge'))
                    .map(b => b.textContent.trim());
                currentRoles.push(role);

                const response = await fetch('/Admin/Users/UpdateUserRoles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        id: userId,
                        roles: currentRoles
                    })
                });

                if (!response.ok) throw new Error('Failed to update roles');
                location.reload();
            } catch (error) {
                console.error(error);
                alert('Failed to update user roles');
            }
        }
    </script>
}